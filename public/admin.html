<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="Tipsy Admin - Tableau de bord d'administration">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://admin.tipsy.francony.fr/">
    <meta property="og:title" content="Tipsy Admin">
    <meta property="og:description" content="Tableau de bord d'administration">
    <meta property="og:image" content="https://tipsy.francony.fr/og-image.png">
    <meta property="og:site_name" content="Tipsy">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://admin.tipsy.francony.fr/">
    <meta name="twitter:title" content="Tipsy Admin">
    <meta name="twitter:description" content="Tableau de bord d'administration">
    <meta name="twitter:image" content="https://tipsy.francony.fr/og-image.png">

    <title>Tipsy Admin Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: #fff;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .subtitle {
            color: #8892b0;
            text-align: center;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            text-decoration: none;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .card-icon { font-size: 3rem; margin-bottom: 15px; }
        .card-title { color: #fff; font-size: 1.3rem; font-weight: 600; margin-bottom: 8px; }
        .card-description { color: #8892b0; font-size: 0.9rem; line-height: 1.4; }

        .card.tipsy { border-top: 3px solid #f59e0b; }
        .card.status { border-top: 3px solid #10b981; }
        .card.logs { border-top: 3px solid #3b82f6; }
        .card.github { border-top: 3px solid #8b5cf6; }

        /* Collapsible Section */
        .collapsible-section {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            overflow: hidden;
        }

        .collapsible-header {
            padding: 18px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .collapsible-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .collapsible-title {
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapsible-summary {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .summary-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .summary-badge.green { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .summary-badge.yellow { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .summary-badge.red { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        .chevron {
            color: #8892b0;
            transition: transform 0.3s;
            font-size: 1.2rem;
        }

        .collapsible-section.open .chevron {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-section.open .collapsible-content {
            max-height: 1000px;
        }

        .collapsible-inner {
            padding: 0 25px 25px 25px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .stat-icon { font-size: 1.5rem; margin-bottom: 6px; }
        .stat-value { font-size: 1.3rem; font-weight: 700; color: #fff; margin-bottom: 2px; }
        .stat-label { color: #8892b0; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-detail { color: #64748b; font-size: 0.65rem; margin-top: 3px; }

        .stat-value.green { color: #10b981; }
        .stat-value.yellow { color: #f59e0b; }
        .stat-value.red { color: #ef4444; }

        .uptime-row {
            text-align: center;
            color: #8892b0;
            font-size: 0.85rem;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .uptime-row .uptime-value { color: #fff; font-weight: 500; }

        /* SSL Grid */
        .ssl-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .ssl-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .ssl-domain { color: #fff; font-size: 0.75rem; font-weight: 600; margin-bottom: 6px; word-break: break-all; }
        .ssl-days { font-size: 1.5rem; font-weight: 700; margin-bottom: 2px; }
        .ssl-days.green { color: #10b981; }
        .ssl-days.yellow { color: #f59e0b; }
        .ssl-days.red { color: #ef4444; }
        .ssl-label { color: #8892b0; font-size: 0.65rem; text-transform: uppercase; }
        .ssl-expiry { color: #64748b; font-size: 0.6rem; margin-top: 4px; }
        .ssl-error { color: #ef4444; font-size: 0.7rem; }

        /* Docker Grid */
        .docker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .docker-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .docker-status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .docker-status-dot.running { background: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.5); }
        .docker-status-dot.stopped { background: #ef4444; }
        .docker-status-dot.other { background: #f59e0b; }

        .docker-info { flex: 1; min-width: 0; }
        .docker-name { color: #fff; font-size: 0.85rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .docker-status-text { color: #8892b0; font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .stats-error { text-align: center; color: #ef4444; padding: 15px; }
        .stats-loading { text-align: center; color: #8892b0; padding: 15px; }

        .footer {
            margin-top: 40px;
            color: #4a5568;
            font-size: 0.85rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üçπ Tipsy Admin</h1>
        <p class="subtitle">Service Dashboard</p>

        <div class="grid">
            <a href="https://tipsy.francony.fr" class="card tipsy">
                <div class="card-icon">üç∏</div>
                <div class="card-title">Tipsy App</div>
                <div class="card-description">Cocktail ordering application</div>
            </a>

            <a href="https://status.tipsy.francony.fr" class="card status">
                <div class="card-icon">üìä</div>
                <div class="card-title">Status</div>
                <div class="card-description">Uptime monitoring & alerts</div>
            </a>

            <a href="https://logs.tipsy.francony.fr" class="card logs">
                <div class="card-icon">üìú</div>
                <div class="card-title">Logs</div>
                <div class="card-description">Real-time container logs</div>
            </a>

            <a href="https://github.com/AlexandreFrancony?tab=repositories&q=bartending" target="_blank" class="card github">
                <div class="card-icon">üíª</div>
                <div class="card-title">GitHub</div>
                <div class="card-description">Source code repositories</div>
            </a>
        </div>

        <!-- System Stats Section -->
        <div class="collapsible-section" id="stats-section">
            <div class="collapsible-header" onclick="toggleSection('stats-section')">
                <div class="collapsible-title">üìä System Status</div>
                <div class="collapsible-summary">
                    <span id="stats-summary"></span>
                    <span class="chevron">‚ñº</span>
                </div>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-inner" id="stats-content">
                    <div class="stats-loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Docker Containers Section -->
        <div class="collapsible-section" id="docker-section">
            <div class="collapsible-header" onclick="toggleSection('docker-section')">
                <div class="collapsible-title">üê≥ Docker Containers</div>
                <div class="collapsible-summary">
                    <span id="docker-summary"></span>
                    <span class="chevron">‚ñº</span>
                </div>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-inner" id="docker-content">
                    <div class="stats-loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- SSL Certificates Section -->
        <div class="collapsible-section" id="ssl-section">
            <div class="collapsible-header" onclick="toggleSection('ssl-section')">
                <div class="collapsible-title">üîí SSL Certificates</div>
                <div class="collapsible-summary">
                    <span id="ssl-summary"></span>
                    <span class="chevron">‚ñº</span>
                </div>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-inner" id="ssl-content">
                    <div class="stats-loading">Loading...</div>
                </div>
            </div>
        </div>

        <div class="footer">
            Tipsy Admin Portal &bull; Hosted on Raspberry Pi 4
        </div>
    </div>

    <script>
        // Toggle collapsible section
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('open');
        }

        // Format bytes to human readable
        function formatBytes(bytes) {
            const gb = bytes / (1024 * 1024 * 1024);
            return gb.toFixed(1) + ' GB';
        }

        // Format uptime to human readable
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);

            let parts = [];
            if (days > 0) parts.push(days + 'd');
            if (hours > 0) parts.push(hours + 'h');
            if (minutes > 0) parts.push(minutes + 'm');

            return parts.join(' ') || '< 1m';
        }

        // Get color class based on value and thresholds
        function getColorClass(value, yellowThreshold, redThreshold) {
            if (value >= redThreshold) return 'red';
            if (value >= yellowThreshold) return 'yellow';
            return 'green';
        }

        // Get SSL color class (inverted - lower is worse)
        function getSSLColorClass(days) {
            if (days <= 14) return 'red';
            if (days <= 30) return 'yellow';
            return 'green';
        }

        // Format date for display
        function formatExpiryDate(isoDate) {
            const date = new Date(isoDate);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }

        // Render system stats
        function renderStats(data) {
            const container = document.getElementById('stats-content');
            const summary = document.getElementById('stats-summary');

            const tempColor = data.cpu_temp !== null ? getColorClass(data.cpu_temp, 60, 75) : 'green';
            const ramColor = getColorClass(data.memory_percent, 70, 85);
            const diskColor = getColorClass(data.disk_percent, 80, 90);

            // Determine overall status for summary
            const worstColor = [tempColor, ramColor, diskColor].includes('red') ? 'red' :
                              [tempColor, ramColor, diskColor].includes('yellow') ? 'yellow' : 'green';

            summary.innerHTML = `<span class="summary-badge ${worstColor}">${data.cpu_temp !== null ? data.cpu_temp + '¬∞C' : 'N/A'} ‚Ä¢ ${data.memory_percent.toFixed(0)}% RAM</span>`;

            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üå°Ô∏è</div>
                        <div class="stat-value ${tempColor}">${data.cpu_temp !== null ? data.cpu_temp + '¬∞C' : 'N/A'}</div>
                        <div class="stat-label">CPU Temp</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíª</div>
                        <div class="stat-value ${getColorClass(data.cpu_percent, 70, 90)}">${data.cpu_percent.toFixed(0)}%</div>
                        <div class="stat-label">CPU</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíæ</div>
                        <div class="stat-value ${ramColor}">${data.memory_percent.toFixed(0)}%</div>
                        <div class="stat-label">RAM</div>
                        <div class="stat-detail">${formatBytes(data.memory_used)} / ${formatBytes(data.memory_total)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-value ${diskColor}">${data.disk_percent.toFixed(0)}%</div>
                        <div class="stat-label">Disk</div>
                        <div class="stat-detail">${formatBytes(data.disk_used)} / ${formatBytes(data.disk_total)}</div>
                    </div>
                </div>
                <div class="uptime-row">
                    ‚è±Ô∏è Uptime: <span class="uptime-value">${formatUptime(data.uptime_seconds)}</span>
                </div>
            `;
        }

        // Render Docker containers
        function renderDocker(dockerData) {
            const container = document.getElementById('docker-content');
            const summary = document.getElementById('docker-summary');

            if (dockerData.error) {
                summary.innerHTML = `<span class="summary-badge red">Error</span>`;
                container.innerHTML = `<div class="stats-error">‚ö†Ô∏è ${dockerData.error}</div>`;
                return;
            }

            const containers = dockerData.containers || [];
            const runningCount = containers.filter(c => c.state === 'running').length;
            const totalCount = containers.length;

            const statusColor = runningCount === totalCount ? 'green' : runningCount > 0 ? 'yellow' : 'red';
            summary.innerHTML = `<span class="summary-badge ${statusColor}">${runningCount}/${totalCount} running</span>`;

            if (containers.length === 0) {
                container.innerHTML = '<div class="stats-loading">No bartending containers found</div>';
                return;
            }

            const cardsHtml = containers.map(c => {
                const dotClass = c.state === 'running' ? 'running' : c.state === 'exited' ? 'stopped' : 'other';
                const displayName = c.name.replace('bartending_', '');
                return `
                    <div class="docker-card">
                        <div class="docker-status-dot ${dotClass}"></div>
                        <div class="docker-info">
                            <div class="docker-name">${displayName}</div>
                            <div class="docker-status-text">${c.status}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="docker-grid">${cardsHtml}</div>`;
        }

        // Render SSL certificates
        function renderSSL(certificates) {
            const container = document.getElementById('ssl-content');
            const summary = document.getElementById('ssl-summary');

            if (!certificates || certificates.length === 0) {
                summary.innerHTML = '<span class="summary-badge yellow">No certs</span>';
                container.innerHTML = '<div class="stats-error">No SSL certificates configured</div>';
                return;
            }

            const minDays = Math.min(...certificates.filter(c => !c.error).map(c => c.days_remaining));
            const hasErrors = certificates.some(c => c.error);
            const statusColor = hasErrors ? 'red' : getSSLColorClass(minDays);

            summary.innerHTML = `<span class="summary-badge ${statusColor}">${hasErrors ? 'Error' : minDays + ' days'}</span>`;

            const cardsHtml = certificates.map(cert => {
                if (cert.error) {
                    return `
                        <div class="ssl-card">
                            <div class="ssl-domain">${cert.domain}</div>
                            <div class="ssl-error">‚ö†Ô∏è Error</div>
                        </div>
                    `;
                }

                const colorClass = getSSLColorClass(cert.days_remaining);
                return `
                    <div class="ssl-card">
                        <div class="ssl-domain">${cert.domain}</div>
                        <div class="ssl-days ${colorClass}">${cert.days_remaining}</div>
                        <div class="ssl-label">days</div>
                        <div class="ssl-expiry">${formatExpiryDate(cert.expiry_date)}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="ssl-grid">${cardsHtml}</div>`;
        }

        // Fetch and display all stats
        async function fetchStats() {
            try {
                const response = await fetch('https://tipsy.francony.fr/webhook/stats');
                if (!response.ok) throw new Error('Failed to fetch');

                const data = await response.json();

                renderStats(data);
                renderSSL(data.ssl_certificates);
                renderDocker(data.docker || { containers: [] });

            } catch (error) {
                document.getElementById('stats-summary').innerHTML = '<span class="summary-badge red">Offline</span>';
                document.getElementById('stats-content').innerHTML = '<div class="stats-error">‚ö†Ô∏è Unable to fetch stats</div>';
                document.getElementById('docker-summary').innerHTML = '<span class="summary-badge red">Offline</span>';
                document.getElementById('docker-content').innerHTML = '<div class="stats-error">‚ö†Ô∏è Unable to fetch</div>';
                document.getElementById('ssl-summary').innerHTML = '<span class="summary-badge red">Offline</span>';
                document.getElementById('ssl-content').innerHTML = '<div class="stats-error">‚ö†Ô∏è Unable to fetch</div>';
            }
        }

        // Initial fetch
        fetchStats();

        // Refresh every 5 seconds
        setInterval(fetchStats, 5000);
    </script>
</body>
</html>
